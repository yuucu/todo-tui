name: Coverage Report

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  GO_VERSION: "1.24"

jobs:
  coverage:
    name: Detailed Coverage Report
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run detailed coverage analysis
      id: coverage
      uses: ./.github/actions/test-coverage
      with:
        go-version: ${{ env.GO_VERSION }}
        upload-codecov: 'true'
        comment-pr: 'true'

    - name: Generate coverage badge
      run: |
        COVERAGE=${{ steps.coverage.outputs.coverage-percentage }}
        
        # カバレッジに基づいて色を決定
        if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
          COLOR="brightgreen"
        elif (( $(echo "$COVERAGE >= 70" | bc -l) )); then
          COLOR="green"
        elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
          COLOR="yellow"
        elif (( $(echo "$COVERAGE >= 50" | bc -l) )); then
          COLOR="orange"
        else
          COLOR="red"
        fi
        
        # バッジURL生成
        BADGE_URL="https://img.shields.io/badge/coverage-${COVERAGE}%25-${COLOR}"
        echo "Badge URL: $BADGE_URL"
        echo "BADGE_URL=$BADGE_URL" >> $GITHUB_ENV

    - name: Coverage summary
      run: |
        echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Total Coverage:** ${{ steps.coverage.outputs.coverage-percentage }}%" >> $GITHUB_STEP_SUMMARY
        echo "**Threshold:** 70%" >> $GITHUB_STEP_SUMMARY
        if (( $(echo "${{ steps.coverage.outputs.coverage-percentage }} >= 70" | bc -l) )); then
          echo "**Status:** ✅ PASS" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Status:** ⚠️  BELOW THRESHOLD" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "![Coverage Badge](${{ env.BADGE_URL }})" >> $GITHUB_STEP_SUMMARY 